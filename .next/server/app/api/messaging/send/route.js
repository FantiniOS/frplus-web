"use strict";(()=>{var e={};e.id=9521,e.ids=[9521],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7544:(e,s,t)=>{t.r(s),t.d(s,{headerHooks:()=>E,originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>h});var a={};t.r(a),t.d(a,{GET:()=>u,POST:()=>l});var r=t(95419),n=t(69108),o=t(99678),i=t(19631),c=t(78070);async function l(e){try{let{clienteId:s,tipo:t,mensagem:a,assunto:r}=await e.json(),n=await i._.cliente.findUnique({where:{id:s}});if(!n)return c.Z.json({error:"Cliente n\xe3o encontrado"},{status:404});let o={success:!1,message:""};if("whatsapp"===t){let e=process.env.EVOLUTION_API_URL,s=process.env.EVOLUTION_API_KEY,t=process.env.EVOLUTION_INSTANCE;if(e&&s&&t){let r=(n.celular||n.telefone).replace(/\D/g,""),i=r.startsWith("55")?r:`55${r}`;try{let r=await fetch(`${e}/message/sendText/${t}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:s},body:JSON.stringify({number:i,text:a})});if(r.ok){let e=await r.json();o={success:!0,message:"Mensagem enviada via WhatsApp",externalId:e.key?.id}}else{let e=await r.text();o={success:!1,message:`Erro WhatsApp: ${e}`}}}catch(e){o={success:!1,message:`Erro de conex\xe3o: ${e}`}}}else console.log(`[WhatsApp Demo] Enviando para ${n.celular||n.telefone}: ${a}`),o={success:!0,message:"Mensagem registrada (modo demo - configure EVOLUTION_API_URL)"}}else if("email"===t){let e=process.env.RESEND_API_KEY,s=process.env.RESEND_FROM_EMAIL||"onboarding@resend.dev";if(e)try{let t=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({from:s,to:n.email,subject:r||"Mensagem de FRPlus",text:a})});if(t.ok){let e=await t.json();o={success:!0,message:"Email enviado com sucesso",externalId:e.id}}else{let e=await t.text();o={success:!1,message:`Erro Resend: ${e}`}}}catch(e){o={success:!1,message:`Erro de conex\xe3o: ${e}`}}else console.log(`[Email Demo] Enviando para ${n.email}: ${a}`),o={success:!0,message:"Email registrado (modo demo - configure RESEND_API_KEY)"}}if(await i._.contatoCliente.create({data:{clienteId:s,tipo:t,mensagem:a,status:o.success?"enviado":"erro"}}),o.success)return c.Z.json({success:!0,message:o.message,externalId:o.externalId});return c.Z.json({success:!1,error:o.message},{status:500})}catch(e){return console.error("Error sending message:",e),c.Z.json({error:"Erro ao enviar mensagem"},{status:500})}}async function u(e){try{let{searchParams:s}=new URL(e.url),t=s.get("clienteId"),a=await i._.contatoCliente.findMany({where:t?{clienteId:t}:{},include:{cliente:{select:{nomeFantasia:!0,razaoSocial:!0}}},orderBy:{createdAt:"desc"},take:50});return c.Z.json(a)}catch(e){return console.error("Error fetching contacts:",e),c.Z.json({error:"Erro ao buscar contatos"},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/messaging/send/route",pathname:"/api/messaging/send",filename:"route",bundlePath:"app/api/messaging/send/route"},resolvedPagePath:"E:\\FRPlus\\frplus-web\\src\\app\\api\\messaging\\send\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:E,staticGenerationBailout:h}=d,f="/api/messaging/send/route";function v(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},19631:(e,s,t)=>{t.d(s,{_:()=>r});let a=require("@prisma/client"),r=globalThis.prisma??new a.PrismaClient}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),a=s.X(0,[1638,6206],()=>t(7544));module.exports=a})();