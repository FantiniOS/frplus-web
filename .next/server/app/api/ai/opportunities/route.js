"use strict";(()=>{var e={};e.id=6407,e.ids=[6407],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4294:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c,staticGenerationBailout:()=>g});var i={};a.r(i),a.d(i,{GET:()=>l});var o=a(95419),r=a(69108),n=a(99678),s=a(19631),p=a(78070);async function l(){try{let e=await s._.cliente.findMany({include:{pedidos:{include:{itens:{include:{produto:!0}}},orderBy:{data:"desc"}}}}),t=await s._.produto.findMany({include:{fabrica:!0}}),a=[],i=new Date().getMonth();for(let o of e){if(0===o.pedidos.length)continue;let e=o.pedidos.slice(0,10),r=e.filter(e=>new Date(e.data).getMonth()===i);e.some(e=>"50a199"===e.tabelaPreco)&&r.length>=3&&a.push({type:"upgrade",clienteId:o.id,clienteNome:o.nomeFantasia,description:`${r.length} pedidos este m\xeas na tabela 50-199. Sugerir migra\xe7\xe3o para 200-699.`,priority:"alta",actionLabel:"Propor Upgrade"});let n=new Set(e.flatMap(e=>e.itens.map(e=>e.produtoId))),s=new Set(e.flatMap(e=>e.itens.map(e=>e.produto.fabricaId))),p=t.filter(e=>s.has(e.fabricaId)&&!n.has(e.id));if(p.length>0){let e=p[0];a.push({type:"crossSell",clienteId:o.id,clienteNome:o.nomeFantasia,description:`Nunca comprou "${e.nome}" da ${e.fabrica.nome}. ${p.length} produtos dispon\xedveis.`,priority:"media",actionLabel:"Oferecer Produto"})}let l=o.pedidos.filter(e=>new Date(e.data).getMonth()===i),d=o.pedidos.length/12;l.length>1.5*d&&l.length<2*d&&a.push({type:"seasonal",clienteId:o.id,clienteNome:o.nomeFantasia,description:`Historicamente compra mais neste m\xeas. Momento ideal para contato.`,priority:"media",actionLabel:"Contatar Cliente"})}let o={alta:0,media:1,baixa:2};return a.sort((e,t)=>o[e.priority]-o[t.priority]),p.Z.json({opportunities:a.slice(0,20),summary:{total:a.length,upgrade:a.filter(e=>"upgrade"===e.type).length,crossSell:a.filter(e=>"crossSell"===e.type).length,seasonal:a.filter(e=>"seasonal"===e.type).length}})}catch(e){return console.error("Error fetching opportunities:",e),p.Z.json({error:"Failed to fetch opportunities"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/ai/opportunities/route",pathname:"/api/ai/opportunities",filename:"route",bundlePath:"app/api/ai/opportunities/route"},resolvedPagePath:"E:\\FRPlus\\frplus-web\\src\\app\\api\\ai\\opportunities\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:c,serverHooks:m,headerHooks:h,staticGenerationBailout:g}=d,f="/api/ai/opportunities/route";function y(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}},19631:(e,t,a)=>{a.d(t,{_:()=>o});let i=require("@prisma/client"),o=globalThis.prisma??new i.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[1638,6206],()=>a(4294));module.exports=i})();